name: Gemini AI Code Review

# Triggers on PRs targeting 'main'
on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff
        id: get_diff
        run: |
          # Ensure we have the refs (checkout@v4 + fetch-depth: 0 should be enough, but be defensive)
          git fetch origin "${{ github.event.pull_request.base.sha }}" || true
          git fetch origin "${{ github.event.pull_request.head.sha }}" || true

          DIFF_OUTPUT=$(git diff "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}" || true)

          # Publish the diff as a step output
          echo "diff_content<<EOF" >> "$GITHUB_OUTPUT"
          echo "$DIFF_OUTPUT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Call Gemini API
        id: call_gemini
        if: ${{ steps.get_diff.outputs.diff_content != '' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_DIFF: ${{ steps.get_diff.outputs.diff_content }}
        run: |
          # Build the prompt using the PR diff
          PROMPT_TEMPLATE="You are an expert code reviewer. Your goal is to provide a concise, high-level summary of the code changes and identify potential issues.

          Please review the following code changes (git diff format) and provide feedback. Focus on:
            - Potential bugs or logic errors
            - Security vulnerabilities
            - Performance improvements
            - Adherence to best practices and code style
            - Readability and maintainability

          Do not comment on minor stylistic things unless they significantly impact readability.
          Structure your feedback in Markdown format. Start with a brief summary.

          Here is the diff:
          \`\`\`diff
          $PR_DIFF
          \`\`\`"

          # Build JSON payload safely with jq
          JSON_PAYLOAD=$(jq -n --arg prompt "$PROMPT_TEMPLATE" \
            '{ "contents": [ { "parts": [ { "text": $prompt } ] } ] }')

          # Send to Gemini
          API_RESPONSE=$(curl -sS -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro-latest:generateContent?key=${GEMINI_API_KEY}")

          REVIEW_CONTENT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [[ -z "$REVIEW_CONTENT" ]]; then
            echo "::error::Gemini API did not return valid content."
            echo "Full API Response: $API_RESPONSE"
            exit 1
          fi

          # Publish the review as a step output
          echo "review_body<<EOF" >> "$GITHUB_OUTPUT"
          echo "$REVIEW_CONTENT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post Review Comment
        if: ${{ success() && steps.call_gemini.outputs.review_body != '' }}
        uses: actions/github-script@v7
        env:
          REVIEW_BODY: ${{ steps.call_gemini.outputs.review_body }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Use the review body from env to avoid inlining problems
            const reviewBody = process.env.REVIEW_BODY || '';
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### ðŸ¤– Gemini Code Review\n\n---\n\n${reviewBody}`
            });