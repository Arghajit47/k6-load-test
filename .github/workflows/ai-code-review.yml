name: Gemini AI Code Review

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout full PR history
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Extract PR diff safely (base64 encoded)
      - name: Get PR Diff
        id: get_diff
        run: |
          git fetch origin "${{ github.event.pull_request.base.sha }}" || true
          git fetch origin "${{ github.event.pull_request.head.sha }}" || true

          DIFF_OUTPUT=$(git diff "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}" || true)

          # Encode diff safely to avoid parsing issues
          ENCODED_DIFF=$(echo "$DIFF_OUTPUT" | base64 -w 0)
          echo "diff_content=$ENCODED_DIFF" >> "$GITHUB_OUTPUT"

      # 3Ô∏è‚É£ Call Gemini API with diff content
      - name: Call Gemini API
        id: call_gemini
        if: ${{ steps.get_diff.outputs.diff_content != '' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ENCODED_DIFF: ${{ steps.get_diff.outputs.diff_content }}
        run: |
          # Decode diff
          PR_DIFF=$(echo "$ENCODED_DIFF" | base64 --decode)

          # Build structured prompt
          PROMPT_TEMPLATE=$(cat <<EOF
          You are an expert code reviewer. Provide a concise, high-level review of the following code changes in Git diff format.

          Focus on:
            - Potential bugs or logic errors
            - Security vulnerabilities
            - Performance improvements
            - Adherence to best practices and maintainability

          Do not mention trivial style issues.

          Here is the diff:
          \`\`\`diff
          ${PR_DIFF}
          \`\`\`
          EOF
          )

          # Create request payload
          JSON_PAYLOAD=$(jq -n --arg prompt "$PROMPT_TEMPLATE" \
            '{ "contents": [ { "parts": [ { "text": $prompt } ] } ] }')

          echo "Sending review request to Gemini..."
          API_RESPONSE=$(curl -sS -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${GEMINI_API_KEY}")

          REVIEW_CONTENT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [[ -z "$REVIEW_CONTENT" ]]; then
            echo "::error::Gemini API did not return valid content."
            echo "Full API Response: $API_RESPONSE"
            exit 1
          fi

          echo "review_body<<EOF" >> "$GITHUB_OUTPUT"
          echo "$REVIEW_CONTENT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # 4Ô∏è‚É£ Post Gemini Review as PR Comment
      - name: Post Review Comment
        if: ${{ steps.call_gemini.outputs.review_body != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reviewBody = process.env.REVIEW_BODY || '';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### ü§ñ Gemini Code Review\n\n---\n\n${reviewBody}`
            });
        env:
          REVIEW_BODY: ${{ steps.call_gemini.outputs.review_body }}
