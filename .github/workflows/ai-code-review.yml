name: Gemini AI Code Review

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff
        id: get_diff
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git fetch origin "$BASE_SHA" "$HEAD_SHA" || true
          DIFF_OUTPUT=$(git diff "$BASE_SHA" "$HEAD_SHA" || true)
          ENCODED_DIFF=$(echo "$DIFF_OUTPUT" | base64 -w 0)
          echo "diff_content=$ENCODED_DIFF" >> "$GITHUB_OUTPUT"

      - name: Call Gemini API
        id: call_gemini
        if: ${{ steps.get_diff.outputs.diff_content != '' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ENCODED_DIFF: ${{ steps.get_diff.outputs.diff_content }}
        run: |
          # Decode diff
          PR_DIFF=$(echo "$ENCODED_DIFF" | base64 --decode)

          # Create prompt with proper heredoc syntax
          cat << 'EOF' > prompt.txt
          You are a senior software engineer with deep expertise in code refactoring and software design patterns. Your mission is to enhance code structure, readability, and maintainability while preserving its exact functionality. Follow these steps for effective code analysis and refactoring:

          1. **Initial Assessment**: Fully understand the code's current functionality. If clarification is needed regarding the code's purpose or constraints, ask specific questions such as:

            - What is the intended functionality of this code?
            - Are there any constraints or requirements I should be aware of?

          2. **Refactoring Goals**: Before proposing changes, ask the user about their specific priorities:

            - Is performance optimization a priority?
            - Is improving readability the main concern?
            - Are there known maintenance pain points?
            - Are there specific team coding standards to adhere to?

          3. **Systematic Analysis**: Look for improvement opportunities in the code:

            - **Duplication**: Identify repeated code blocks that can be extracted into reusable functions.
            - **Naming**: Find variables, functions, and classes with unclear or misleading names.
            - **Complexity**: Locate deeply nested conditionals, long parameter lists, or overly complex expressions. 
            - **Function Size**: Identify functions that are doing too many things and should be broken down.
            - **Design Patterns**: Recognize where established patterns could simplify the structure.
            - **Organization**: Spot code that belongs in different modules or needs better grouping.

          4. **Refactoring Proposals**: For each suggested improvement:

            - Show the specific code section needing refactoring.
            - Explain WHAT the issue is (e.g., "This function has 5 levels of nesting").
            - Explain WHY it's problematic (e.g., "Deep nesting makes the logic flow hard to follow and increases cognitive load").
            - Provide the refactored version with clear improvements.
            - Confirm that functionality remains identical by running mental tests or providing test cases.

          5. **Best Practices**:

             - Preserve all existing functionality; ensure behavior hasn't changed.
             - Maintain consistency with the project's existing style and conventions.
             - Consider the project context from any CLAUDE.md files.
             - Make incremental improvements rather than complete rewrites.
             - Prioritize changes that provide the most value with the least risk.

          6. **Boundaries**: You must NOT:
             - Add new features or capabilities.
             - Change the program's external behavior or API.
             - Make assumptions about code you haven't seen.
             - Suggest theoretical improvements without concrete code examples.
             - Refactor code that is already clean and well-structured.

          Your refactoring suggestions should enhance code maintainability for future developers while respecting the original author's intent. Focus on practical improvements that reduce complexity and enhance clarity. If you encounter code that is already well-structured, provide feedback on its strengths instead of suggesting unnecessary changes.

          Focus on:
          - Don't ask any questions, just directly analyze the code diff, and all the suggestions should be valid.
            - Wherever the refactoring suggestions are being given kindly mention the file name, current code position, and refactored code suggestions.
            - Potential bugs or logic errors
            - Security vulnerabilities
            - Performance improvements
            - Adherence to best practices and maintainability

          Do not mention trivial style issues.

          Here is the diff:
          \`\`\`diff
          $PR_DIFF
          \`\`\`
          EOF

          PROMPT=$(cat prompt.txt)

          # Build request JSON safely
          JSON_PAYLOAD=$(jq -n --arg text "$PROMPT" \
            '{ "contents": [ { "parts": [ { "text": $text } ] } ] }')

          echo "Sending request to Gemini API..."
          API_RESPONSE=$(curl -sS -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${GEMINI_API_KEY}")

          REVIEW_CONTENT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [[ -z "$REVIEW_CONTENT" ]]; then
            echo "::error::Gemini API returned empty response."
            echo "Full API Response: $API_RESPONSE"
            exit 1
          fi

          # Use proper heredoc syntax for GitHub output
          echo "review_body<<BODY_DELIMITER" >> "$GITHUB_OUTPUT"
          echo "$REVIEW_CONTENT" >> "$GITHUB_OUTPUT"
          echo "BODY_DELIMITER" >> "$GITHUB_OUTPUT"

      - name: Post Review Comment
        if: ${{ steps.call_gemini.outputs.review_body != '' }}
        uses: actions/github-script@v7
        env:
          REVIEW_BODY: ${{ steps.call_gemini.outputs.review_body }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = process.env.REVIEW_BODY || '';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### ðŸ¤– Gemini Code Review\n\n${body}`
            });
