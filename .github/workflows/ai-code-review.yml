name: Gemini AI Code Review

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff
        id: get_diff
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git fetch origin "$BASE_SHA" "$HEAD_SHA" || true
          DIFF_OUTPUT=$(git diff "$BASE_SHA" "$HEAD_SHA" || true)
          ENCODED_DIFF=$(echo "$DIFF_OUTPUT" | base64 -w 0)
          echo "diff_content=$ENCODED_DIFF" >> "$GITHUB_OUTPUT"

      - name: Call Gemini API
        id: call_gemini
        if: ${{ steps.get_diff.outputs.diff_content != '' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ENCODED_DIFF: ${{ steps.get_diff.outputs.diff_content }}
        run: |
          # Decode diff
          PR_DIFF=$(echo "$ENCODED_DIFF" | base64 --decode)

          # Build prompt safely
          cat > prompt.txt <<'PROMPT'
          You are an expert code reviewer. Provide a concise, high-level review of the following code changes in Git diff format.

          Focus on:
            - Potential bugs or logic errors
            - Security vulnerabilities
            - Performance improvements
            - Adherence to best practices and maintainability

          Do not mention trivial style issues.

          Here is the diff:
          \`\`\`diff
          $PR_DIFF
          \`\`\`
          EOF
          )

          # Build request JSON safely
          JSON_PAYLOAD=$(jq -n --arg text "$PROMPT_TEMPLATE" \
            '{ contents: [ { parts: [ { text: $text } ] } ] }')

          echo "Sending request to Gemini API..."
          API_RESPONSE=$(curl -sS -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-pro-latest:generateContent?key=${GEMINI_API_KEY}")

          REVIEW_CONTENT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [[ -z "$REVIEW_CONTENT" ]]; then
            echo "::error::Gemini API returned empty response."
            echo "Full API Response: $API_RESPONSE"
            exit 1
          fi

          echo "review_body<<EOF" >> "$GITHUB_OUTPUT"
          echo "$REVIEW_CONTENT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post Review Comment
        if: ${{ steps.call_gemini.outputs.review_body != '' }}
        uses: actions/github-script@v7
        env:
          REVIEW_BODY: ${{ steps.call_gemini.outputs.review_body }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = process.env.REVIEW_BODY || '';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### ðŸ¤– Gemini Code Review\n\n${body}`
            });
